name: Weekly Supabase Backup

on:
  schedule:
    - cron: '0 0 * * 1' # Jalan setiap Senin jam 07:00 WIB
  workflow_dispatch:    # Tombol manual

jobs:
  backup_database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Backup using Docker (Guaranteed v17)
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          FILENAME="backup_langitan_$TIMESTAMP.sql"
          
          echo "Memulai backup menggunakan Docker Postgres 17..."
          
          # --- BAGIAN INI KUNCINYA ---
          # Kita menjalankan pg_dump dari dalam container Docker resmi versi 17.
          # Tidak perlu install apa-apa, dia akan download otomatis.
          # Hasilnya langsung disimpan ke file di folder kita.
          
          docker run --rm postgres:17 pg_dump "$DATABASE_URL" -F p > "$FILENAME"
          
          # Cek apakah file berhasil terisi
          if [ -s "$FILENAME" ]; then
            echo "Sukses! File backup berhasil dibuat."
          else
            echo "Gagal! File backup kosong."
            exit 1
          fi
          
          # Zip file agar hemat tempat
          zip "$FILENAME.zip" "$FILENAME"
          rm "$FILENAME"
          
          # Simpan nama file untuk step upload
          echo "BACKUP_FILE=$FILENAME.zip" >> $GITHUB_ENV

      - name: Upload to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_id }}
          path: ${{ env.BACKUP_FILE }}
          retention-days: 90